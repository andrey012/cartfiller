(function(){

(function(document, window, undefined){
    'use strict';
    var minified = !('undefined' === typeof this.cartFillerConfiguration);
    this.cartFillerConfiguration = {
        minified: minified,
        scripts: [],
        launch: function(){
            this.modules.ui.framed(document, window);
        }
    }
    var scripts = document.getElementsByTagName('head')[0].getElementsByTagName('script');
    var me = scripts[scripts.length - 1];
    var baseUrl = me.getAttribute('src').replace(/\/boot\/[^\/]+\.js(\?\d*)?/, '');
    this.cartFillerConfiguration.baseUrl = baseUrl;
    var attrs = me.attributes;
    for (var j = attrs.length - 1 ; j >= 0; j --){
        if (/^data-/.test(attrs[j].name)){
            this.cartFillerConfiguration[attrs[j].name] = attrs[j].value;
        }
    }
    if (!minified) {
        var script = document.createElement('script');
        script.setAttribute('src', baseUrl + '/boot/helpers/loader.js');
        document.getElementsByTagName('head')[0].appendChild(script);
    }
}).call(this, document, window);
(function(document, window, undefined){
    var highlightedElement = false;
    var me = this.cartFillerConfiguration;
    me.scripts.push({
        name: 'api',
        registerWorker: function(cb){
            me.modules.dispatcher.registerWorker(cb, this);
            return this;
        },
        result: function(message, recoverable){
            me.modules.dispatcher.submitWorkerResult(message, recoverable);
            return this;
        },
        onload: function(cb){
            me.modules.dispatcher.registerWorkerOnloadCallback(cb);
            return api;
        },
        waitFor: function(checkCallback, resultCallback, timeout){
            if (undefined === timeout){
                timeout = 20000;
            }
            var period = 200;
            var counter = timeout / period;
            var fn = function(){
                var result = checkCallback();
                if (false === me.modules.dispatcher.getWorkerCurrentStepIndex()) return;
                if (result) {
                    resultCallback(result);
                } else {
                    counter --;
                    if (counter > 0){
                        setTimeout(fn, period);
                    } else {
                        resultCallback(false);
                    }
                }
            }
            setTimeout(fn, period);
            return this;
        },
        highlight: function(element, allElements){
            me.modules.ui.highlight(element, allElements);
            me.modules.dispatcher.setHighlightedElement(element);
            return this;
        }

    });
}).call(this, document, window);(function(document, window, undefined){
    'use strict';
    var
        worker = false,
        workerCurrentTaskIndex = false,
        workerCurrentStepIndex = false,
        workerOnLoadHandler = false,
        resultMessageName = false;    
    var mainFrameLoaded = false,
        workerFrameLoaded = false,
        bootstrapped = false;
    var highlightedElement = false;
    var me = this.cartFillerConfiguration;
    var postMessage = function(toWindow, cmd, details, messageName){
        if (undefined === messageName){
            messageName = 'cartFillerMessage';
        }
        if (undefined === details) {
            details = {};
        }
        details.cmd = cmd;
        toWindow.postMessage(
            messageName + ':' + JSON.stringify(details),
            '*'
        );

    }
    var resetWorker = function(){
        workerCurrentTaskIndex = workerCurrentStepIndex = workerOnLoadHandler = false;
    }

    this.cartFillerConfiguration.scripts.push({
        name: 'dispatcher',
        init: function(){
            var dispatcher = this;
            window.addEventListener('message', function(event) {
                var pattern = /^cartFillerMessage:(.*)$/;
                var test = pattern.exec(event.data);
                if (null != test){
                    var message = JSON.parse(test[1]);
                    var fn = 'onMessage_' + message.cmd;
                    dispatcher[fn](message);
                }
            }, false);
        },
        onMessage: function(event){

        },
        onMessage_register: function(message){
            workerFrameLoaded = true;
            if (mainFrameLoaded && !bootstrapped){
                this.bootstrapCartFiller();
            }
        },
        onMessage_makeSmaller: function(){
            me.modules.ui.setSize('small');
        },
        onMessage_makeBigger: function(){
            me.modules.ui.setSize('big');
        },
        onMessage_toggleSize: function(){
            me.modules.ui.setSize();
        },
        onMessage_chooseJob: function(){
            me.modules.ui.showHideChooseJobFrame(true);
        },
        onMessage_chooseJobCancel: function(){
            me.modules.ui.showHideChooseJobFrame(false);
        },
        onMessage_jobDetails: function(message){
            if (message.resultMessage){
                resultMessageName = message.resultMessage;
            } else {
                resultMessageName = false;
            }
            me.modules.ui.showHideChooseJobFrame(false);
            this.postMessageToWorker('jobDetails', message);
        },
        onMessage_sendResult: function(message){
            me.modules.ui.showHideChooseJobFrame(true);
            if (resultMessageName){
                this.postMessageToChooseJob(resultMessageName, message);
            }
        },
        onMessage_loadWorker: function(message){
            if ("string" === typeof me['data-worker']){
                message.src = me['data-worker'];
            }
            var workerScript = document.createElement('script');
            if (/\?/.test(message.src)){
                message.src += '&';
            } else {
                message.src += '?';
            }
            message.src += (new Date()).getTime();
            workerScript.setAttribute('src', message.src);
            worker = false;
            document.getElementsByTagName('body')[0].appendChild(workerScript);
        },
        onMessage_invokeWorker: function(message){
            if ((false !== workerCurrentTaskIndex) || (false !== workerCurrentStepIndex)){
                var err = 'ERROR: worker task is in still in progress';
                alert(err);
                this.postMessage('workerStepResult', {index: message.index, step: message.step, result: err});
            } else {
                workerCurrentTaskIndex = message.index;
                workerCurrentStepIndex = message.step;
                var env = {
                    messageIndex: message.index
                }
                try {
                    worker[message.task][(message.step * 2) + 1](message.details, highlightedElement, env);
                } catch (err){
                    alert(err);
                    debugger;
                    throw err;
                }
            }
        },
        onMessage_resetWorker: function(){
            resetWorker();
        },
        onMainFrameLoaded: function() {
            mainFrameLoaded = true;
            if (workerFrameLoaded && !bootstrapped){
                this.bootstrapCartFiller();
            }
            if (workerOnLoadHandler) workerOnLoadHandler();
        },
        postMessageToWorker: function(cmd, details){
            postMessage(me.modules.ui.workerFrameWindow, cmd, details);
        },
        postMessageToChooseJob: function(cmd, details){
            postMessage(me.modules.ui.chooseJobFrameWindow, cmd, details, cmd);
        },
        bootstrapCartFiller: function(){
            bootstrapped = true;
            this.postMessageToWorker('bootstrap', {lib : me.baseUrl.replace(/src/, 'lib/'), debug: me['data-debug']});
        },
        registerWorker: function(cb, api){
            worker = cb(me.modules.ui.mainFrameWindow, undefined, api);
            var list = {};
            for (var taskName in worker){
                if (worker.hasOwnProperty(taskName)){
                    var taskSteps = [];
                    for (var i = 0 ; i < worker[taskName].length; i++){
                        if ("string" === typeof worker[taskName][i]){
                            taskSteps.push(worker[taskName][i]);
                        }
                    }
                    list[taskName] = taskSteps;
                }
            }
            this.postMessageToWorker('workerRegistered', {jobTaskDescriptions: list});
        },
        submitWorkerResult: function(message, recoverable){
            var status;
            if ((undefined === message) || ("" === message)) {
                status = 'ok';
            } else if ("string" === typeof message){
                status = recoverable ? 'skip' : 'error';
            } else {
                throw "invalid message type " + typeof(message);
            }
            this.postMessageToWorker(
                'workerStepResult', 
                {
                    index: workerCurrentTaskIndex, 
                    step: workerCurrentStepIndex, 
                    status: status, 
                    message: message
                }
            );
            resetWorker();
        },
        registerWorkerOnloadCallback: function(cb){
            workerOnLoadHandler = cb;
        },
        getWorkerCurrentStepIndex: function(){
            return workerCurrentStepIndex;
        },
        setHighlightedElement: function(element){
            highlightedElement = element;
        }

    });
}).call(this, document, window);(function(document, window, undefined){
    var require = [
        'dispatcher',
        'ui',
        'api'
    ];
    var me = this;
    var onScriptLoaded = function(){
        for (var i in require){
            var found = false;
            for (var j in me.cartFillerConfiguration.scripts){
                if (me.cartFillerConfiguration.scripts[j].name === require[i]){
                    found = true;
                }
            }
            if (!found) return;
        }
        //// TBD global API variable name
        window.cartFillerAPI = function(){
            return me.cartFillerConfiguration.modules.api;
        }
        me.cartFillerConfiguration.modules = {};
        for (var j in me.cartFillerConfiguration.scripts){
            var script = me.cartFillerConfiguration.scripts[j];
            me.cartFillerConfiguration.modules[script.name] = script;
        }
        me.cartFillerConfiguration.launch();
    }
    this.cartFillerConfiguration.scripts.push = function(value){
        Array.prototype.push.call(this, value);
        onScriptLoaded();
    }
    var head = document.getElementsByTagName('head')[0];
    if (!this.cartFillerConfiguration.minified) {
        for (var i in require){
            var script = document.createElement('script');
            script.setAttribute('src', this.cartFillerConfiguration.baseUrl + '/boot/helpers/' + require[i] + '.js');
            head.appendChild(script);
        }
    }
}).call(this, document, window);(function(document, window, undefined){
    var me = this.cartFillerConfiguration;
    var currentSize;
    var overlayClassName = 'cartFillerOverlayDiv';

    var getDocument = function(){
        return me.modules.ui.mainFrameWindow.document;
    }
    var getScrollLeft = function(){
        return getDocument().documentElement.scrollLeft || getDocument().body.scrollLeft;
    }
    var getScrollTop = function(){
        return  getDocument().documentElement.scrollTop || getDocument().body.scrollTop;

    }
    var createOverlay = function(left, top, right, bottom){
        var div =  getDocument().createElement('div');
        div.style.position = 'absolute';
        div.style.left = left + 'px';
        div.style.top = top + 'px';
        div.style.width = (right - left) + 'px';
        div.style.height = (bottom - top) + 'px';
        div.style.backgroundColor = 'rgba(0,0,0,0.3)';
        div.style.zIndex = 100000;
        div.className = overlayClassName;
        div.onclick = function(){removeOverlay();};
        getDocument().getElementsByTagName('body')[0].appendChild(div);

    };
    var scrollTo = function(left, top, right, bottom){
        var centerX = (right + left ) / 2;
        var centerY = (bottom + top) / 2;
        var currentX, currentY;
        var destX = centerX - ( getDocument().documentElement.clientWidth / 2);
        var destY = centerY - ( getDocument().documentElement.clientHeight / 2);
        while (true){
            currentX = getScrollLeft();
            currentY = getScrollTop();
            me.modules.ui.mainFrameWindow.scrollBy(destX - currentX, destY -  currentY);
            if (getScrollLeft() == currentX &&
                getScrollTop() == currentY) {
                break;
            }
        }

    };
    var removeOverlay = function(){
        var divs =  getDocument().getElementsByClassName(overlayClassName);
        for (var i = divs.length - 1; i >= 0 ; i--){
            divs[i].parentNode.removeChild(divs[i]);
        }
    };

    me.scripts.push({
        name: 'ui',
        setSize: function() {},
        showHideChooseJobFrame: function() {},
        highlight: function(){},
        framed: function(document, window) {
            me.modules.dispatcher.init();
            var body = document.getElementsByTagName('body')[0];
            var mainFrameName = 'cartFillerMainFrame',
                mainFrameSrc = window.location.href,
                workerFrameName = 'cartFillerWorkerFrame',
                workerFrameSrc = me.baseUrl + '/index.html',
                chooseJobFrameName = 'cartFillerChooseJobFrame',
                chooseJobFrameSrc = me['data-choose-job'],
                windowWidth = window.innerWidth,
                windowHeight = window.innerHeight,
                mainFrameWidthBig = windowWidth * 0.8 - 1,
                mainFrameWidthSmall = windowWidth * 0.2 - 1,
                workerFrameWidthBig = windowWidth * 0.8 - 1,
                workerFrameWidthSmall = windowWidth * 0.2 - 1,
                framesHeight = windowHeight - 15,
                chooseJobFrameLeft = 0.02 * windowWidth,
                chooseJobFrameWidth = 0.76 * windowWidth,
                chooseJobFrameTop = 0.02 * windowHeight,
                chooseJobFrameHeight = 0.96 * windowHeight,
                currentSize = 'big';



            while (body.children.length) body.removeChild(body.children[0]);
            this.mainFrame = document.createElement('iframe');
            this.mainFrame.setAttribute('name', mainFrameName);
            this.mainFrame.style.height = framesHeight + 'px';
            this.mainFrame.style.position = 'fixed';
            this.mainFrame.style.left = '0px';
            this.mainFrame.style.top = '0px';

            this.workerFrame = document.createElement('iframe');
            this.workerFrame.setAttribute('name', workerFrameName);
            this.workerFrame.style.height = framesHeight + 'px';
            this.workerFrame.style.position = 'fixed';
            this.workerFrame.style.top = '0px';

            this.chooseJobFrame = document.createElement('iframe');
            this.chooseJobFrame.setAttribute('name', chooseJobFrameName);
            this.chooseJobFrame.style.display = 'none';
            this.chooseJobFrame.style.height = chooseJobFrameHeight + 'px';
            this.chooseJobFrame.style.top = chooseJobFrameTop + 'px';
            this.chooseJobFrame.style.left = chooseJobFrameLeft + 'px';
            this.chooseJobFrame.style.width = chooseJobFrameWidth + 'px';
            this.chooseJobFrame.style.position = 'fixed';
            this.chooseJobFrame.style.background = 'white';
            body.appendChild(this.mainFrame);
            this.mainFrameWindow = window.frames[mainFrameName];

            this.mainFrame.onload = function(){
                me.modules.dispatcher.onMainFrameLoaded();
            }

            this.mainFrameWindow.location.href=mainFrameSrc;
            body.appendChild(this.workerFrame);
            this.workerFrameWindow = window.frames[workerFrameName];
            this.workerFrameWindow.location.href=workerFrameSrc;
            body.appendChild(this.chooseJobFrame);
            this.chooseJobFrameWindow = window.frames[chooseJobFrameName];
            this.chooseJobFrameWindow.location.href=chooseJobFrameSrc;

            this.setSize = function(size){
                if (undefined === size) {
                    size = (currentSize == 'big') ? 'small' : 'big';
                }
                currentSize = size;
                if (size == 'big') {
                    this.workerFrame.style.width = workerFrameWidthBig + 'px';
                    this.mainFrame.style.width = mainFrameWidthSmall + 'px';
                    this.workerFrame.style.left = mainFrameWidthSmall + 'px';
                } else if (size == 'small') {
                    this.workerFrame.style.width = workerFrameWidthSmall + 'px';
                    this.mainFrame.style.width = mainFrameWidthBig + 'px';
                    this.workerFrame.style.left = mainFrameWidthBig + 'px';
                }
            };

            this.showHideChooseJobFrame = function(show){
                this.chooseJobFrame.style.display = show ? 'block' : 'none';
            }

            this.highlight = function(element, allElements){
                var rect;
                if (undefined != this.mainFrameWindow.jQuery && (element instanceof this.mainFrameWindow.jQuery)){
                    if (1 > element.length) {
                        element = undefined;
                    } else {
                        if (true === allElements) {
                            rect = {left: undefined, right: undefined, top: undefined, bottom: undefined};
                            element.each(function(i,el){
                                var thisRect = el.getBoundingClientRect();
                                rect.left = (undefined === rect.left) ? thisRect.left : Math.min(rect.left, thisRect.left);
                                rect.right = (undefined === rect.right) ? thisRect.right : Math.max(rect.right, thisRect.right);
                                rect.top = (undefined === rect.top) ? thisRect.top : Math.min(rect.top, thisRect.top);
                                rect.bottom = (undefined === rect.bottom) ? thisRect.bottom : Math.max(rect.bottom, thisRect.bottom);
                            });
                         } else {
                            rect = element[0].getBoundingClientRect();                
                         }
                    }
                } else if (undefined !== element) {
                    rect = element.getBoundingClientRect();                
                }
                var body = this.mainFrameWindow.document.getElementsByTagName('body')[0];
                var full = body.getBoundingClientRect();
                var scrollTop = getScrollTop();
                var scrollLeft = getScrollLeft();
                var pageRight = Math.max(full.right + scrollLeft, body.scrollWidth, this.mainFrameWindow.innerWidth) - 1;
                var pageBottom = Math.max(full.bottom + scrollTop, body.scrollHeight, this.mainFrameWindow.innerHeight) - 1;
                removeOverlay();
                if (undefined !== element) {
                    var border = 5;
                    createOverlay(0, 0, Math.max(0, rect.left + scrollLeft - border), pageBottom);
                    createOverlay(Math.min(pageRight, rect.right + scrollLeft + border), 0, pageRight, pageBottom);
                    createOverlay(Math.max(0, rect.left + scrollLeft - border), 0, Math.min(pageRight, rect.right + scrollLeft + border), Math.min(pageBottom, rect.top + scrollTop - border));
                    createOverlay(Math.max(0, rect.left + scrollLeft - border), Math.max(0, rect.bottom + scrollTop + border), Math.min(pageRight, rect.right + scrollLeft + border), pageBottom);
                    scrollTo(rect.left + scrollLeft, rect.top + scrollTop, rect.right + scrollLeft, rect.bottom + scrollTop);
                } else {
                    createOverlay(0, 0, pageRight, pageBottom);
                }

            }

            this.setSize('big');
        }
    });
}).call(this, document, window);

}).call(new (function(){this.cartFillerConfiguration = {};}));

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
    </head>
    <body>
        <h1>
            Hello, this is local file operation tab, please do not close it
        </h1>
        <a id="openpopup" style="display: none;" href="#">Popups seem to be blocked, click here to open popup</a>
        <div id="bookmarklets">
            Bookmarklets for launching from filesystem:
        </div>
        <div>
            <h3>
                Configure:
            </h3>
            <table>
                <tbody>
                    <tr>
                        <td>URL to launch:</td>
                        <td><input type="text" id="url"/></td>
                    </tr>
                    <tr>
                        <td>ChooseJob URL:</td>
                        <td><input type="text" id="choosejob"/></td>
                        <td>Hint: if started with # then testsuite will be started, you only may need to put things like job=...&task=...&step=... here if necessary</td>
                    </tr>
                    <tr>
                        <td>Path to testsuite:</td>
                        <td><input type="text" id="root"/></td>
                    </tr>
                    <tr>
                        <td>Editor mode:</td>
                        <td><input type="text" id="editor"/></td>
                    </tr>
                    <tr>
                        <td>Full URL to cartFiller location inside target project</td>
                        <td><input type="text" id="cartFillerInstallationUrl"/></td>
                    </tr>
                    <tr>
                        <td>Generated ChooseJob URL:</td>
                        <td><span id="generatedChoosejob"></span></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <p>
            Some template files: <a download="cartfiller.json" href="data:application/json;base64,base64-content-of-cartfiller.json-goes-here">cartfiller.json</a>, <a download="test.json" href="data:application/json;base64,base64-content-of-test.json-goes-here">test.json</a>, <a target="_blank" href="data:application/javascript;base64,base64-content-of-worker.js-goes-here">worker.js</a>
        <p>
            This file is designed to be opened from local filesystem, e.g. file:///home/user/cartfiller/local/index.html.</p>
        <p>
            There are two ways of using this file: it can be opened first, or it can be opened in a popup tab, that CartFiller opens, when it wants to access local file. 
        </p>
        <p>
            When opened first, you should open this file with a hash url, so, that full URL looks like: 
        </p>
        <p>
            file:///home/user/cartfiller/local/index.html#url=https://andrey012.github.io/cartfiller/dist?root=file:///home/user/cartfiller/testsuite
        </p>
        <p>
            Of course you should replace /home/user/cartfiller with where cartfiller is on your local disk, and where the testsuite is.
        </p>
        <h3>
            Log
        </h3>
        <pre id="log"></pre>
        <script>
            (function() {
                var parent = window.opener;
                var bootstrapped = false;
                var log = function(msg) {
                    document.getElementById('log').textContent += msg + '\n';
                };
                var init = function() {
                    log('sending init');
                    parent.postMessage('cartFillerFilePopupInit', '*');
                };
                window.addEventListener('error', function(event) {
                    debugger;
                    parent.postMessage('cartFillerFilePopupData:', '*');
                });
                window.addEventListener('message', function(event) {
                    var p = /^cartFillerFilePopupUrl:(.*)$/;
                    if (p.test(event.data)) {
                        var s = document.createElement('script');
                        var url = p.exec(event.data)[1];
                        s.setAttribute('src', url);
                        document.getElementsByTagName('body')[0].appendChild(s);
                        document.getElementById('log').textContent += 'requesting: ' + url + '\n';
                    } else if (event.data === 'cartFillerFilePopupPing') {
                        if (! event.source) {
                            log('ping received, but source is not set');
                        } else if (parent !== event.source) {
                            log('ping received from different parent');
                            parent = event.source;
                            init();
                        } else {
                            log('ping received from same parent');
                        }
                   } else if (0 === event.data.indexOf('cartFillerMessage')) {
                        log('CartFiller tries to register as slave, going to bootstrap it');
                        if ((! parent) || (parent !== event.source && event.source)) {
                            log('Adjusting parent');
                            parent = event.source;
                        }
                        parent.postMessage('cartFillerMessage:{"cmd":"launchFromSlave"}', '*');
                    } else if ('/^\'cartFillerEval\'/' === event.data) {
                        log('got inject.js request');
                        if ((! parent) || (parent !== event.source && event.source)) {
                            log('Adjusting parent');
                            parent = event.source;
                        }
                        if (!injectjs.length) {
                            alert('You are using source local.html, it does not have payload to launch cartFiller');
                        }
                        parent.postMessage('\'cartFillerEval\';this.cartFillerEval[2]=' + JSON.stringify($('#generatedChoosejob').text()) + ';' + injectjs, '*');
                    }
                }, false);
                Object.defineProperty(window, 'cartfiller', {set: function(v) {
                    var json = JSON.stringify(v);
                    log('received: ' + json.length + ' bytes, parent is ' + (parent ? 'not null' : 'null') + '\n');
                    parent.postMessage('cartFillerFilePopupData:' + json, '*');
                }});
                window.cartFillerAPI = function() {
                    return {
                        registerWorker: function(callback) {
                            var code = '(function(window, document, undefined){cartFillerAPI().registerWorker(' + callback.toString() + ')})(window, document);';
                            log('received: ' + code.length + ' bytes, parent is ' + (parent ? 'not null' : 'null') + '\n');
                            parent.postMessage('cartFillerFilePopupData:' + code, '*');
                        }
                    }
                };
                if (parent) {
                    init();
                } else {
                    var m = /^#?url=([^&]+)/.exec(window.location.hash);
                    if (m) {
                        var url = decodeURIComponent(m[1]);
                        try {
                            parent = window.open(url, '_blank');
                        } catch (e) {}
                        if (parent) {
                            log('looks like we managed to open popup');
                        } else {
                            log('could not open popup');
                            var a = document.getElementById('openpopup');
                            a.style.display = 'block';
                            a.onclick = function() {
                                log('trying to open popup in onclick');
                                parent = window.open(url, '_blank');
                                if (parent) {
                                    log('looks like we managed to open popup in onclick');
                                    a.style.display = 'none';
                                } else {
                                    log('could not open popup in onclick');
                                }
                                return false;
                            };
                        }
                    } else {    
                        log('no window.opener initially set, waiting for ping');
                    }
                }

                var injectjs = '';
            })();
        </script>
        <script src="../../lib/requirejs/require.js"></script>
        <script>
            (function() {
                var paths = {
                    'jquery': '../../lib/jquery/dist/jquery.min',
                    'jquery-cartFiller': '../jquery-cartFiller'
                };
                var deps = ['jquery', 'jquery-cartFiller'];
                var shim = {'jquery-cartFiller': 'jquery'};
                require.config({
                    paths: paths,
                    shim: shim,
                    deps: deps,
                    waitSeconds: 30
                });
                require(['jquery-cartFiller', 'jquery'], function() {
                    for (var type in {'framed':1,'popup':1}) {
                        var a = $('<a/>');
                        $('#bookmarklets').append(a);
                        $('#bookmarklets').append(', ');
                        a.text(type);
                        a.cartFillerPlugin({
                            baseUrl: '',
                            chooseJob: '',
                            debug: 1,
                            inject: 'iframe',
                            minified: /local\.uncompressed\.html/.test(window.location.href) ? false: true,
                            type: type
                        });
                    }
                    var parseHash = function(initInputs) {
                        var pc = window.location.hash.replace(/^#/, '').split('&');
                        var fields = {};
                        for (var i in pc) {
                            var ppc = pc[i].split('=');
                            var name = ppc.shift();
                            var value = ppc.join('=');
                            fields[name] = decodeURIComponent(value);
                            if (initInputs) {
                                 $('#' + name).val(fields[name]);
                            }
                        }
                        var v = '';
                        if ('string' === typeof fields.choosejob && fields.choosejob.length) {
                            v += fields.choosejob;
                        }
                        var pc = [];
                        for (var f in {root:1, editor:1, cartFillerInstallationUrl:1}) {
                            if ('string' === typeof fields[f] && fields[f].length) {
                                pc.push(f + '=' + encodeURIComponent(fields[f]));
                            }
                        }
                        if (pc.length) {
                            v += ((0 === v.indexOf('#')) ? '&' : '#') + pc.join('&');
                        }
                        $('#generatedChoosejob').text(v);

                    };
                    var update = function() {
                        var hash = [];
                        $('input').each(function(i,el){
                            hash.push($(el).attr('id') + '=' + encodeURIComponent($(el).val()));
                        });
                        window.location.hash = '#' + hash.join('&');
                        parseHash();
                        return;
                    };
                    $('input').change(update).keyup(update);
                    parseHash(true);
                });
            })();
        </script>
    </body>
</html>

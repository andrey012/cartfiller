<!DOCTYPE html>
<html>
    <head>
    </head>
    <body>
        <h1>
            Hello, this is local file operation tab, please do not close it
        </h1>
        <a id="openpopup" style="display: none;" href="#">Popups seem to be blocked, click here to open popup</a>
        <p>
            This file is designed to be opened from local filesystem, e.g. file:///home/user/cartfiller/local/index.html.</p>
        <p>
            There are two ways of using this file: it can be opened first, or it can be opened in a popup tab, that CartFiller opens, when it wants to access local file. 
        </p>
        <p>
            When opened first, you should open this file with a hash url, so, that full URL looks like: 
        </p>
        <p>
            file:///home/user/cartfiller/local/index.html#url=https://andrey012.github.io/cartfiller/dist?root=file:///home/user/cartfiller/testsuite
        </p>
        <p>
            Of course you should replace /home/user/cartfiller with where cartfiller is on your local disk, and where the testsuite is.
        </p>
        <h3>
            Log
        </h3>
        <pre id="log"></pre>
        <script>
            console.log('local.html started');
            (function() {
                var parent = window.opener;
                var bootstrapped = false;
                var log = function(msg) {
                    document.getElementById('log').textContent += msg + '\n';
                };
                var init = function() {
                    log('sending init');
                    parent.postMessage('cartFillerFilePopupInit', '*');
                };
                window.addEventListener('message', function(event) {
                    var p = /^cartFillerFilePopupUrl:(.*)$/;
                    if (p.test(event.data)) {
                        var s = document.createElement('script');
                        var url = p.exec(event.data)[1];
                        s.setAttribute('src', url);
                        document.getElementsByTagName('body')[0].appendChild(s);
                        document.getElementById('log').textContent += 'requesting: ' + url + '\n';
                    } else if (event.data === 'cartFillerFilePopupPing') {
                        if (! event.source) {
                            log('ping received, but source is not set');
                        } else if (parent !== event.source) {
                            log('ping received from different parent');
                            parent = event.source;
                            init();
                        } else {
                            log('ping received from same parent');
                        }
                   } else if (0 === event.data.indexOf('cartFillerMessage')) {
                        log('CartFiller tries to register as slave, going to bootstrap it');
                        if ((! parent) || (parent !== event.source && event.source)) {
                            log('Adjusting parent');
                            parent = event.source;
                        }
                        parent.postMessage('cartFillerMessage:{"cmd":"launchFromSlave"}', '*');
                    } else if ('/^\'cartFillerEval\'/' === event.data) {
                        log('got inject.js request');
                        if ((! parent) || (parent !== event.source && event.source)) {
                            log('Adjusting parent');
                            parent = event.source;
                        }
                        parent.postMessage('\'cartFillerEval\';' + injectjs, '*');
                    }
                }, false);
                Object.defineProperty(window, 'cartfiller', {set: function(v) {
                    var json = JSON.stringify(v);
                    log('received: ' + json.length + ' bytes, parent is ' + (parent ? 'not null' : 'null') + '\n');
                    parent.postMessage('cartFillerFilePopupData:' + json, '*');
                }});
                window.cartFillerAPI = function() {
                    return {
                        registerWorker: function(callback) {
                            var code = '(function(window, document, undefined){cartFillerAPI().registerWorker(' + callback.toString() + ')})(window, document);';
                            log('received: ' + code.length + ' bytes, parent is ' + (parent ? 'not null' : 'null') + '\n');
                            parent.postMessage('cartFillerFilePopupData:' + code, '*');
                        }
                    }
                };
                if (parent) {
                    init();
                } else {
                    var m = /^#?url=([^&]+)/.exec(window.location.hash);
                    if (m) {
                        var url = decodeURIComponent(m[1]);
                        try {
                            parent = window.open(url, '_blank');
                        } catch (e) {}
                        if (parent) {
                            log('looks like we managed to open popup');
                        } else {
                            log('could not open popup');
                            var a = document.getElementById('openpopup');
                            a.style.display = 'block';
                            a.onclick = function() {
                                log('trying to open popup in onclick');
                                parent = window.open(url, '_blank');
                                if (parent) {
                                    log('looks like we managed to open popup in onclick');
                                    a.style.display = 'none';
                                } else {
                                    log('could not open popup in onclick');
                                }
                                return false;
                            };
                        }
                    } else {    
                        log('no window.opener initially set, waiting for ping');
                    }
                }
                var injectjs = '';
            })();
        </script>
    </body>
</html>

/*
 *  cartFiller - v0.0.1
 *  Tool for automating cart filling process when doing big purchases
 *  https://andrey012.github.com/cartFiller
 *
 *  Made by Andrey Grinenko
 *  Under MIT License
 */
!function(a,b,c,d){"use strict";function e(b,c){this.settings=a.extend({},i,c),this._defaults=i,this._name=f,"undefined"!=typeof b&&(this.element=b,this.init())}var f="cartFillerPlugin",g=!1,h=[],i={chooseJob:"",baseUrl:"",inject:"script",minified:!0,type:"framed",debug:!1,worker:"",traceStartup:!1,logLength:!1,useSource:!1,workerFrameUrl:"",useBuildVersion:!1},j={};j.gruntBuildTimeStamp="",a.extend(e.prototype,{init:function(){g?a(this.element).hide():(this.settings.logLength&&console.log("generated bookmarklet: "+href.length),a(this.element).attr("href",this.javaScriptUrl()+this.getBookmarkletCode()),h.push(this.element))},getBookmarkletCode:function(){return"script"===this.settings.inject?this.scriptBookmarklet():"eval"===this.settings.inject?this.evalBookmarklet():"iframe"===this.settings.inject?this.iframeBookmarklet():void alert('invalid inject value, correct values are "script", "eval" and "iframe"')},getTypeId:function(){return"framed"===this.settings.type?0:"popup"===this.settings.type?1:(alert('type not set or invalid, should be either "framed" or "popup"'),0)},getInjectUrl:function(){var a;return a=this.settings.minified?"inject.min.js":"inject.js",(this.settings.useSource?"/boot/":"/")+a},getIframeUrl:function(){return(this.settings.useSource?"/boot/":"/")+"i.htm"},trace:function(a){return this.settings.traceStartup?"alert('"+a+"');":""},getVersion:function(){return this.settings.useBuildVersion&&j.gruntBuildTimeStamp?j.gruntBuildTimeStamp:"(new Date()).getTime()"},scriptBookmarklet:function(){return"try{"+this.trace("start")+"(function(d,c,a,t,o,b,e,u,v,j,k,x,y,w,z,m,n,s){"+this.trace("in function")+"s=d.createElement('script');"+this.trace("script element created")+"s[a](c+t,o);"+this.trace("type set")+"s[a](c+b,e);"+this.trace("base-url set")+"s[a](u,e+v+'?'+"+this.getVersion()+");"+this.trace("src set")+"s[a](c+j,k);"+this.trace("choose-job set")+"if(x)s[a](c+x,y);"+this.trace("debug set")+"if(w)s[a](c+w,z);"+this.trace("worker set")+"if(m)s[a](c+m,n);"+this.trace("worker URL set")+"s.onerror=function(){alert('error');};"+this.trace("onerror set")+"d.getElementsByTagName('head')[0].appendChild(s);"+this.trace("script element added")+"})(document,'data-','setAttribute','type',"+this.getTypeId()+",'base-url','"+this.settings.baseUrl+"','src','"+this.getInjectUrl()+"','choose-job','"+this.settings.chooseJob+"','debug',"+(this.settings.debug?1:0)+",'worker','"+this.settings.worker+"','wfu','"+this.settings.workerFrameUrl+"');}catch(e){alert(e);}"},evalBookmarklet:function(){return"try{"+this.trace("start")+"(function(f,x,t,u,v,j,d,w){"+this.trace("in function")+"x.open('GET',u+v+'?'+"+this.getVersion()+",true);"+this.trace("x opened")+"x.onload=function(){try{"+this.trace("x onload called")+"f=1;eval('(function(){'+x.response+'}).call({cartFillerEval:[u,t,j,d,w]});');"+this.trace("eval complete")+"}catch(e){alert(e);}};"+this.trace("x onload set")+"setTimeout(function(){if(!f)alert('error');},5000);"+this.trace("onerror set")+"x.send();"+this.trace("x sent")+"})(0,new XMLHttpRequest(),"+this.getTypeId()+",'"+this.settings.baseUrl+"','"+this.getInjectUrl()+"','"+this.settings.chooseJob+"',"+(this.settings.debug?1:0)+",'"+this.settings.workerFrameUrl+"');}catch(e){alert(e);}"},iframeBookmarklet:function(){return"try{"+this.trace("start")+"(function(f,d,p,t,u,v,m,j,y,x,i,w){"+this.trace("in")+"window.addEventListener('message',function(e){if(f)return;try{"+this.trace("event")+"if(p.test(x=e.data)){"+this.trace("event+")+"f=1;eval('(function(){'+x+'}).call({cartFillerEval:[u,t,j,y,w,\"\",x]});');"+this.trace("eval done")+"}}catch(e){alert(e);}},true);if(!u){"+this.trace("local")+"window.opener.postMessage(p.toString(),'*');}else{"+this.trace("lstnr+")+"i=d.createElement('iframe');"+this.trace("iframe")+"d.getElementsByTagName('body')[0].appendChild(i);"+this.trace("iframe+")+"i.contentWindow.location.href=u+v+(m?'?min&':'?')+"+this.getVersion()+";"+this.trace("iframe++")+"}setTimeout(function(){if(!f)alert('error');},5000);"+this.trace("timeout set")+"})(0,document,/^'cartFillerEval'/,"+this.getTypeId()+",'"+this.settings.baseUrl+"','"+this.getIframeUrl()+"',"+(this.settings.minified?1:0)+",'"+this.settings.chooseJob+"',"+(this.settings.debug?1:0)+",'"+this.settings.workerFrameUrl+"');}catch(e){alert(e);}"},javaScriptUrl:function(){var a="java",b="script";return a+b+":"}}),a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})};var k,l,m,n,o="cartFillerRequestWorkers",p="helloFromCartFiller",q={},r={},s=!1,t=0,u=function(){var a;for(a in r)if(r.hasOwnProperty(a)&&!r[a])return!1;return!0},v=function(c,d){if(d){if(d!==t)return}else t++,q={},r={};for(var e=function(d,e,f){r[d]=!1;var g=d;d+=/\?/.test(d)?"&":"?",d+=(new Date).getTime(),a.cartFillerPlugin.ajax({url:d,complete:function(a){("undefined"==typeof f||f===t)&&(r[g]=!0,f&&a.responseText===q[g]||(b.parent.postMessage("cartFillerMessage:"+JSON.stringify({cmd:"loadWorker",code:a.responseText,src:g,isFinal:u()||f}),"*"),q[g]=a.responseText),s&&u()&&setTimeout(function(){v(c,e)},1e3))}})},f=0;f<c.length;f++){var g=c[f];e(g,t,d)}},w=function(c){var d=new RegExp("^"+p+":(.*)$");if(d.test(c.data)){var e=JSON.parse(d.exec(c.data)[1]);e.useTopWindowForLocalFileOperations&&(x=c.source||b.parent),a(".cart-filler-submit").show(),a(".cart-filler-helper").hide(),a(h).hide(),g=!0}else{var f=new RegExp("^"+m+":(.*)$").exec(c.data);if(f&&k&&k(JSON.parse(f[1])),f=new RegExp("^"+n+":(.*)$").exec(c.data),f&&l&&l(JSON.parse(f[1])),f=new RegExp("^"+o+":(.*)$").exec(c.data)){var i=JSON.parse(f[1]).urls;v(i)}var j="cartFillerFilePopupData:";if(0===c.data.indexOf(j)&&x){var q=z.shift();z.length&&A(),q.complete({status:200,responseText:c.data.substr(j.length)})}else 0===c.data.indexOf("cartFillerFilePopupInit")&&(c.source&&(x=c.source),A())}};a.cartFillerPlugin=function(a,c,e){d!==a.details&&(c&&(d===a.resultMessage||String(a.resultMessage).length<1)&&(a.resultMessage="cartFillerResultMessage"),e&&(d===a.statusMessage||String(a.statusMessage).length<1)&&(a.statusMessage="cartFillerStatusMessage"),m=a.resultMessage,n=a.statusMessage,k=c,l=e),a.cmd="jobDetails",s=a.trackWorker,b.parent.postMessage("cartFillerMessage:"+JSON.stringify(a),"*")},a.cartFillerPlugin.showChooseJobFrame=function(){b.parent.postMessage("cartFillerMessage:"+JSON.stringify({cmd:"chooseJob"}),"*")},a.cartFillerPlugin.hideChooseJobFrame=function(){b.parent.postMessage("cartFillerMessage:"+JSON.stringify({cmd:"chooseJobCancel"}),"*")},a.cartFillerPlugin.getBookmarkletCode=function(a){var b=new e(d,a);return b.getBookmarkletCode()},b.addEventListener("message",w,!1),b.parent!==b&&b.parent.postMessage('cartFillerMessage:{"cmd":"helloFromPlugin","message":"'+p+'"}',"*"),a(c).ready(function(){g?(a(".cart-filler-submit").show(),a(".cart-filler-helper").hide(),a(h).hide()):(a(".cart-filler-submit").hide(),a(".cart-filler-helper").show())});var x=!1,y=!1,z=[],A=function(){x.postMessage("cartFillerFilePopupUrl:"+z[0].url,"*")};a.cartFillerPlugin.ajax=function(c){if(!g)return void setTimeout(function(){a.cartFillerPlugin.ajax(c)},100);var d=function(){y||(x.postMessage("cartFillerFilePopupPing","*"),setTimeout(d,50))};if(/^file\:\/\/\//.test(c.url))z.push(c),x?1===z.length&&A():(x=b.open('javascript:document.write("<h1>Open cartfiller/local/index.html file from your disk in this tab</h1>");',"_blank"),d());else{var e=new XMLHttpRequest;e.onload=e.onerror=function(){c.complete(e)},e.open("GET",c.url,!0),e.send()}}}(jQuery,window,document);
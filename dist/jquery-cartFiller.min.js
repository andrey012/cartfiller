/*
 *  cartFiller - v0.0.1
 *  Tool for automating cart filling process when doing big purchases
 *  https://andrey012.github.com/cartFiller
 *
 *  Made by Andrey Grinenko
 *  Under MIT License
 */
!function(a,b,c,d){"use strict";function e(b,c){this.settings=a.extend({},i,c),this._defaults=i,this._name=f,"undefined"!=typeof b&&(this.element=b,this.init())}var f="cartFillerPlugin",g=!1,h=[],i={chooseJob:"",baseUrl:"",inject:"script",minified:!0,type:"framed",debug:!1,worker:"",traceStartup:!1,logLength:!1,useSource:!1,workerFrameUrl:"",useBuildVersion:!1},j={};j.gruntBuildTimeStamp="",a.extend(e.prototype,{init:function(){g?a(this.element).hide():(this.settings.logLength&&console.log("generated bookmarklet: "+href.length),a(this.element).attr("href",this.javaScriptUrl()+this.getBookmarkletCode()),h.push(this.element))},getBookmarkletCode:function(){return"script"===this.settings.inject?this.scriptBookmarklet():"eval"===this.settings.inject?this.evalBookmarklet():"iframe"===this.settings.inject?this.iframeBookmarklet():void alert('invalid inject value, correct values are "script", "eval" and "iframe"')},getTypeId:function(){return"framed"===this.settings.type?0:"popup"===this.settings.type?1:"clean"===this.settings.type?2:(alert('type not set or invalid, should be either "framed" or "popup"'),0)},getInjectUrl:function(){var a;return a=this.settings.minified?"inject.min.js":"inject.js",(this.settings.useSource?"/boot/":"/")+a},getIframeUrl:function(){return(this.settings.useSource?"/boot/":"/")+"i.htm"},trace:function(a){return this.settings.traceStartup?"alert('"+a+"');":""},getVersion:function(){return this.settings.useBuildVersion&&j.gruntBuildTimeStamp?j.gruntBuildTimeStamp:"(new Date()).getTime()"},cleanPopup:function(a,b){return 2===this.getTypeId()?a+"=window.open('about:blank','_blank','resizable=1,height=1,width=1,scrollbars=1')||alert('Allow popups and retry');"+this.trace("popped up")+(b?b+"="+a+".document;":""):""},typeIdWithSlaveWorkaround:function(){return 2===this.getTypeId()?"window.opener&&window.opener!==window?0:2":this.getTypeId()},scriptBookmarklet:function(){return"try{"+this.trace("start")+"(function(d,c,a,t,o,b,e,u,v,j,k,x,y,w,z,m,n,s,f){"+this.trace("in function")+this.cleanPopup("f","d")+"s=d.createElement('script');"+this.trace("script element created")+"s[a](c+t,o);"+this.trace("type set")+"s[a](c+b,e);"+this.trace("base-url set")+"s[a](u,e+v+'?'+"+this.getVersion()+");"+this.trace("src set")+"s[a](c+j,k);"+this.trace("choose-job set")+"if(x)s[a](c+x,y);"+this.trace("debug set")+"if(w)s[a](c+w,z);"+this.trace("worker set")+"if(m)s[a](c+m,n);"+this.trace("worker URL set")+"s.onerror=function(){alert('error');};"+this.trace("onerror set")+"d.getElementsByTagName('head')[0].appendChild(s);"+this.trace("script element added")+"})(document,'data-','setAttribute','type',"+this.typeIdWithSlaveWorkaround()+",'base-url','"+this.settings.baseUrl+"','src','"+this.getInjectUrl()+"','choose-job','"+this.settings.chooseJob+"','debug',"+(this.settings.debug?1:0)+",'worker','"+this.settings.worker+"','wfu','"+this.settings.workerFrameUrl+"');}catch(e){alert(e);}"},evalBookmarklet:function(){return"try{"+this.trace("start")+"(function(f,x,u,v,p){"+this.trace("in function")+this.cleanPopup("p")+"x.open('GET',u+v+'?'+"+this.getVersion()+",true);"+this.trace("x opened")+"x.onload=function(){try{"+this.trace("x onload called")+"f=1;"+(2===this.getTypeId()?"p.":"")+"eval('(function(){'+x.response+'}).call({cartFillerEval:[\\''+u+'\\',"+this.getTypeId()+",\\'"+this.settings.chooseJob+"\\',"+(this.settings.debug?1:0)+",\\'"+this.settings.worker+"\\',\\'"+this.settings.workerFrameUrl+"\\']});');"+this.trace("eval complete")+"}catch(e){alert(e);}};"+this.trace("x onload set")+"setTimeout(function(){if(!f)alert('error');},5000);"+this.trace("onerror set")+"x.send();"+this.trace("x sent")+"})(0,new XMLHttpRequest(),'"+this.settings.baseUrl+"','"+this.getInjectUrl()+"');}catch(e){alert(e);}"},cleanWrapForEval:function(a){return 2===this.getTypeId()?a.replace(/(\\*)'/g,function(a,b){return b+b+"\\'"}):a},iframeBookmarklet:function(){var a="p=/^'cartFillerEval'/;window.addEventListener('message',function(e){if(f)return;try{"+this.trace("event")+"if(p.test(x=e.data)){"+this.trace("event+")+"f=1;eval('(function(){'+x+'}).call({cartFillerEval:[\\''+u+'\\',"+this.getTypeId()+",\\'"+this.settings.chooseJob+"\\',"+(this.settings.debug?1:0)+",,\\'\\',\\'"+this.settings.workerFrameUrl+"\\']});');"+this.trace("eval done")+"}}catch(e){alert(e);}},true);"+(this.settings.baseUrl?this.trace("lstnr+")+"i=d.createElement('iframe');"+this.trace("iframe")+"d.getElementsByTagName('body')[0].appendChild(i);"+this.trace("iframe+")+"i.contentWindow.location.href=u+v+'"+(this.settings.minified?"?min&'+":"?'+")+this.getVersion()+";"+this.trace("iframe++"):this.trace("local")+"window.opener"+(2===this.getTypeId()?".opener":"")+".postMessage(p.toString(),'*');")+"setTimeout(function(){if(!f)alert('error');},5000);"+this.trace("timeout set");return"try{"+this.trace("start")+"(function(f,d,u,v,i,w,y,p){"+this.trace("in")+(2===this.getTypeId()?this.cleanPopup("y")+"y.eval('var u=\\''+u+'\\',v=\\''+v+'\\',d=document,f,p;"+this.cleanWrapForEval(a)+"');":a)+"})(0,document,'"+this.settings.baseUrl+"','"+this.getIframeUrl()+"');}catch(e){alert(e);}"},javaScriptUrl:function(){var a="java",b="script";return a+b+":"}}),a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})};var k,l,m,n,o="cartFillerRequestWorkers",p="helloFromCartFiller",q={},r={},s=!1,t=0,u=!1,v=!1,w=0,x=function(){u&&!w&&(u=!1,v=!0,b.parent.postMessage("cartFillerMessage:"+JSON.stringify({cmd:"suspendAjaxRequestsDone"}),"*"))},y=function(){var a;for(a in r)if(r.hasOwnProperty(a)&&!r[a])return!1;return!0},z=function(c,d){if(d){if(d!==t)return}else t++,q={},r={};for(var e=function(d,e,f){r[d]=!1;var g=d;d+=/\?/.test(d)?"&":"?",d+=(new Date).getTime(),a.cartFillerPlugin.ajax({url:d,complete:function(a){("undefined"==typeof f||f===t)&&(r[g]=!0,"string"==typeof a.responseText&&a.responseText.length&&(f&&a.responseText===q[g]||(b.parent.postMessage("cartFillerMessage:"+JSON.stringify({cmd:"loadWorker",code:a.responseText,src:g,isFinal:y()||f}),"*"),q[g]=a.responseText)),s&&y()&&setTimeout(function(){z(c,e)},1e3))},cartFillerTrackSomething:f?!0:!1})},f=0;f<c.length;f++){var g=c[f];e(g,t,d)}},A=function(c){var d,e=new RegExp("^"+p+":(.*)$");if(e.test(c.data))d=JSON.parse(e.exec(c.data)[1]),d.useTopWindowForLocalFileOperations&&(B=c.source||b.parent),a(".cart-filler-submit").show(),a(".cart-filler-helper").hide(),a(h).hide(),g=!0;else{var f=new RegExp("^"+m+":(.*)$").exec(c.data);if(f&&k&&k(JSON.parse(f[1])),f=new RegExp("^"+n+":(.*)$").exec(c.data),f&&(d=JSON.parse(f[1]),d.toggleEditorMode?u||(d.enable?v=!1:(u=!0,x())):l&&l(d)),f=new RegExp("^"+o+":(.*)$").exec(c.data)){var i=JSON.parse(f[1]).urls;z(i)}var j="cartFillerFilePopupData:";if(0===c.data.indexOf(j)&&B){var q=D.shift();D.length&&E(),q.complete({status:200,responseText:c.data.substr(j.length)})}else 0===c.data.indexOf("cartFillerFilePopupInit")&&(c.source&&(B=c.source),E())}};a.cartFillerPlugin=function(a,c,e){d!==a.details&&(c&&(d===a.resultMessage||String(a.resultMessage).length<1)&&(a.resultMessage="cartFillerResultMessage"),e&&(d===a.statusMessage||String(a.statusMessage).length<1)&&(a.statusMessage="cartFillerStatusMessage"),m=a.resultMessage,n=a.statusMessage,k=c,l=e),a.cmd="jobDetails",s=a.trackWorker,b.parent.postMessage("cartFillerMessage:"+JSON.stringify(a),"*")},a.cartFillerPlugin.showChooseJobFrame=function(){b.parent.postMessage("cartFillerMessage:"+JSON.stringify({cmd:"chooseJob"}),"*")},a.cartFillerPlugin.hideChooseJobFrame=function(){b.parent.postMessage("cartFillerMessage:"+JSON.stringify({cmd:"chooseJobCancel"}),"*")},a.cartFillerPlugin.getBookmarkletCode=function(a){var b=new e(d,a);return b.getBookmarkletCode()},b.addEventListener("message",A,!1),b.parent!==b&&b.parent.postMessage('cartFillerMessage:{"cmd":"helloFromPlugin","message":"'+p+'"}',"*"),a(c).ready(function(){g?(a(".cart-filler-submit").show(),a(".cart-filler-helper").hide(),a(h).hide()):(a(".cart-filler-submit").hide(),a(".cart-filler-helper").show())});var B=!1,C=!1,D=[],E=function(){B.postMessage("cartFillerFilePopupUrl:"+D[0].url,"*")};a.cartFillerPlugin.ajax=function(c){if(!g)return void setTimeout(function(){a.cartFillerPlugin.ajax(c)},100);if(c.cartFillerTrackSomething&&(u||v))return void setTimeout(function(){c.complete({})},0);var d=function(){C||(B.postMessage("cartFillerFilePopupPing","*"),setTimeout(d,50))};if(/^file\:\/\/\//.test(c.url))D.push(c),B?1===D.length&&E():(B=b.open('javascript:document.write("<h1>Open cartfiller/dist/local.html file from your disk in this tab</h1>");',"_blank"),d());else{w++,x();var e=new XMLHttpRequest;e.onload=e.onerror=function(){w--,x(),c.complete(e)},e.open("GET",c.url,!0),e.send()}},a.cartFillerPlugin.postMessageToDispatcher=function(a,c){c=c||{},c.cmd=a,b.parent.postMessage("cartFillerMessage:"+JSON.stringify(c),"*")}}(jQuery,window,document);
<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="../lib/qunit/qunit/qunit.css"/>
        <script src="../lib/jquery/dist/jquery.min.js"></script>
        <script src="../lib/qunit/qunit/qunit.js"></script>
    </head>
    <body>
        <iframe name="testFrame" src="sample-shop.html" style="width: 100%; height: 50%">

        </iframe>
        <div id="qunit"></div>
        <div id="qunit-fixture"></div>
        <script>
            $(window).ready(function(){

                var testFrame = window.frames['testFrame'];
                var bookmarkletCount;
                var testFrameSrc;
                var currentBookmarklet = 0;
                setTimeout(function waitForTestFrameToCountBookmarklets(){

                    if (testFrame.document && (testFrame.document.readyState === "complete")){
                        bookmarkletCount = testFrame.jQuery('#bookmarklets a.bookmarklet').length;
                        testFrameSrc = testFrame.location.href;
                        processNextBookmarklet();
                        return;
                    }
                    setTimeout(waitForTestFrameToCountBookmarklets, 100);
                }, 100);
                QUnit.config.testTimeout = 150000;
                var processNextBookmarklet = function(){
                    document.getElementsByName('testFrame')[0].onload = function(){
                        if (currentBookmarklet >= bookmarkletCount) return;
                        var bookmarklet = 
                        testFrame
                        .jQuery('#bookmarklets a.bookmarklet:nth('+currentBookmarklet+')');
                        bookmarklet
                        .each(function(i,el){ el.click(); });
                        currentBookmarklet ++;
                        QUnit.test("QuickRun " + bookmarklet.text(), function(assert){
                            var done = assert.async();
                            var tries = 100;
                            setTimeout(function waitForSubmitLink(){
                                try {
                                    if (!testFrame.jQuery('iframe[name="cartFillerChooseJobFrame"]:visible').length) throw "";
                                    var loaded = "complete" === testFrame.jQuery('iframe[name="cartFillerChooseJobFrame"]')[0].contentDocument.readyState;
                                    var link = testFrame.frames['cartFillerChooseJobFrame'].document.getElementById('sampleSubmitLink');
                                    var chooseJobButton = testFrame.frames['cartFillerWorkerFrame'].jQuery ? testFrame.frames['cartFillerWorkerFrame'].jQuery('#chooseJobButton') : false
                                    if (link && loaded && chooseJobButton && chooseJobButton.text() === 'Cancel') {
                                        link.click();
                                        setTimeout(function waitForWorkerToLoad() {
                                            try {
                                                if (testFrame.frames['cartFillerWorkerFrame'].document.readyState !== "complete") throw "";
                                                var runButton = testFrame.frames['cartFillerWorkerFrame'].document.getElementById('runButton');
                                                if (runButton && !runButton.getAttribute('disabled')){
                                                    runButton.click();
                                                    setTimeout(function waitForCompleted(){
                                                        try {
                                                            if (testFrame.frames['cartFillerWorkerFrame'].document.getElementById('finishReached')) {
                                                                assert.ok(true);
                                                                done();
                                                                testFrame.postMessage('cartFillerMessage:{"cmd":"closePopup"}', '*');
                                                                setTimeout(function(){

                                                                     processNextBookmarklet();
                                                                },100);
                                                                return;
                                                            } 
                                                        } catch (e){}
                                                        setTimeout(waitForCompleted, 100);

                                                    },0);
                                                    return;
                                                }
                                            } catch (e){}
                                            setTimeout(waitForWorkerToLoad, 100);
                                        },0);
                                        return;
                                    }

                                } catch (e) {}
                                setTimeout(waitForSubmitLink, 100);
                            },0);
                        });
                    }
                    testFrame.location.href = testFrameSrc;
                    testFrame.location.reload();
                }
            });
        </script>
    </body>
</html>
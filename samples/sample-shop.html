<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="../lib/bootstrap/dist/css/bootstrap.min.css"/>
        <script src="../lib/jquery/dist/jquery.min.js"></script>
        <script src="../lib/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="../lib/angular/angular.js"></script>
        <script src="../lib/angular-route/angular-route.js"></script>
    </head>
    <body>
        <div id="navbar" class="navbar" ng-controller="navbarController" ng-cloak>
            <div style="float: left;" id="bookmarklets">
                <a href="sample-shop.html#/">Home</a> :
            </div>
            <script>
                var baseUrl = window.location.href.replace(/samples\/sample-shop.html.*$/, '');
                var injectUrl = baseUrl + '/src/boot/inject.js';
                var injectMinifiedUrl = baseUrl + '/src/boot/inject.min.js';
                var injectUrlBase = baseUrl + '/src';
                var injectDeltaUrl = '/boot/inject.js';
                var injectMinifiedDeltaUrl = '/boot/inject.min.js';
                var chooseJobUrl = baseUrl + '/samples/choose-job.html';
                var iframeUrlBase = baseUrl + '/src';
                var iframeDeltaUrl = '/boot/i.htm';
                var iframeMinifiedUrlDelta = '/boot/im.htm';
                var iframeTabMinifiedUrlDelta = '/boot/tm.htm';
                var scriptBookmarklet = function(type,injectUrl){
                    return "javascript:(function(d,c,a,t,o,u,v,j,k,x,y,s){s=d.createElement('script');s[a](u,v+'?'+(new Date()).getTime());if(x)s[a](c+x,y);s[a](c+j,k);s[a](c+t,o);d.getElementsByTagName('head')[0].appendChild(s);})(document,'data-','setAttribute','type'," + type + ",'src','" + injectUrl + "','choose-job','" + chooseJobUrl +"','debug',1);";
                }
                var evalBookmarklet = function(type,injectDeltaUrl){
                    return "javascript:(function(x,t,u,v,j,d){x.open('GET', u+v+'?' +(new Date()).getTime(),true);x.onload=function(){eval('(function(){'+x.response+'}).call({cartFillerEval:[u,t,j,d]});');};x.send();})(new XMLHttpRequest()," + type + ",'" + injectUrlBase + "','" + injectDeltaUrl + "','" + chooseJobUrl + "',1);"
                }
                var iframeBookmarklet = function(type, minified, iframeDeltaUrl){
                    return "javascript:(function(d,p,t,u,v,m,j,y,x,i){window.addEventListener('message',function(e){if(p.test(x=e.data))eval('(function(){'+x+'}).call({cartFillerEval:[u,t,j,y]});')},true);i=d.createElement('iframe');d.getElementsByTagName('body')[0].appendChild(i);i.contentWindow.location.href=u+v+(m?'?min&':'?')+(new Date()).getTime();})(document,/^\'cartFillerEval\'/,"+type+",'" + iframeUrlBase +"','" + iframeDeltaUrl + "'," + (minified ? 1:0) + ",'" + chooseJobUrl + "',1);"
                }
                var div = document.getElementById('bookmarklets');
                var a;
                for (var minified = 0; minified < 2; minified++){
                    for (var type = 0; type < 2; type++){
                        var name = 
                            (minified ? 'Minified ' : 'Unminified ') +
                            (type ? 'Popup ' : 'Framed ');
                        a = document.createElement('a');
                        a.setAttribute('class', 'bookmarklet');
                        a.href = scriptBookmarklet(type, minified ? injectMinifiedUrl : injectUrl);
                        a.textContent = name + 'Script';
                        div.appendChild(a);
                        div.appendChild(document.createTextNode(' : '));

                        a = document.createElement('a');
                        a.setAttribute('class', 'bookmarklet');
                        a.href = evalBookmarklet(type, minified ? injectMinifiedDeltaUrl : injectDeltaUrl);
                        a.textContent = name + 'Eval';
                        div.appendChild(a);
                        div.appendChild(document.createTextNode(' : '));

                        a = document.createElement('a');
                        a.setAttribute('class', 'bookmarklet');
                        a.href = iframeBookmarklet(type, minified, iframeDeltaUrl);
                        a.textContent = name + 'Iframe';
                        div.appendChild(a);
                        div.appendChild(document.createTextNode(' : '));
                    }
                }

            </script>
            <div style="float: right;">
                My cart: <strong>{{cart.totalItems}}</strong> item(s), <strong>{{cart.totalCost | number : 2}}</strong> USD. <a href="sample-shop.html#/cart">Open Cart</a>
            </div>
        </div>
        <div style="clear: both;">

        </div>
        <div id="container" ng-view>

        </div>
        <div id="views" style="display: none;">
            <div id="indexView">
                <form method="get" action="sample-shop.html#/search">
                    <p>
                        Enter part number:
                    </p>
                    <input type="text" name="partNumber"/>
                    <input type="submit" value="Search"/>
                </form>
            </div>
            <div id="cartView">
                <h2>
                    Your cart
                </h2>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Part Number</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="cartItem in cart.items track by $index">
                            <th>{{cartItem.partNumber}}</th>
                            <th>{{cartItem.name}}</th>
                            <th>{{cartItem.price}}</th>
                            <th>{{cartItem.amount}}</th>
                            <th>{{cartItem.price * cartItem.amount | number : 2}}</th>
                        </tr>
                    </tbody>
                </table>
                <a href="#" onclick="return false;" ng-click="clearCart()" class="btn btn-danger">Remove all items</a>
                <a href="#" onclick="return false;" class="btn btn-success">Check out</a>
            </div>
            <div id="searchView">
                <h2>
                    Search results
                </h2>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Part number</th>
                            <th>Name</th>
                            <th>Delivery days</th>
                            <th>Price</th>
                            <th>Add to cart</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat-start="(rowIndex,row) in searchResults track by $index">
                            <td>{{row.partNumber}}</td>
                            <td>{{row.name}}</td>
                            <td>{{row.deliveryDays}}</td>
                            <td>{{row.price}}</td>
                            <td>
                                <input type="text" ng-model="row.quantity"/>
                                <a href="#" onclick="return false;" ng-click="addToCart(rowIndex)">Add to cart</a>
                            </td>
                        </tr>
                        <tr ng-repeat-end ng-if="row.wasAdded">
                            <td colspan="5"><strong>{{row.wasAdded}}</strong> item{{(row.wasAdded > 1) ? 's were' : ' was'}} added to cart</td>
                        </tr>
                        <tr ng-if="!searchResults.length">
                            <td ng-if="partNumber.length" colspan="5">Nothing found for <strong>{{partNumber}}</strong></td>
                            <td ng-if="!partNumber.length" colspan="5">Empty search request</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <script>
            angular
            .module("sampleShopApp", ['ngRoute'])
            .config(function($routeProvider, $locationProvider){

                $routeProvider
                    .when('/cart', {
                        controller: 'cartController',
                        template: document.getElementById('cartView').innerHTML
                    })
                    .when('/', {
                        controller: 'indexController',
                        template: document.getElementById('indexView').innerHTML
                    })
                    .otherwise({
                        controller: 'searchController',
                        template: document.getElementById('searchView').innerHTML
                    })
                    ;
            })
            .controller('indexController', function($scope, $rootScope, $location){
                if (/\?partNumber\=/.test($location.absUrl())){
                    $location.path("/search");
                }
            })
            .controller('navbarController', function($scope, $rootScope){
                if (angular.isUndefined($rootScope.cart)){
                    var stored = localStorage.getItem('sampleShopCart');
                    if (stored){
                        $rootScope.cart = JSON.parse(stored);
                    } else {
                        $rootScope.cart = {};
                        $rootScope.cart.totalItems = 0;
                        $rootScope.cart.totalCost = 0;
                        $rootScope.cart.items = [];
                    }
                }
            })
            .controller('cartController', function($scope, $rootScope){
                $scope.clearCart = function(){
                    $rootScope.cart = {};
                    $rootScope.cart.totalItems = 0;
                    $rootScope.cart.totalCost = 0;
                    $rootScope.cart.items = [];
                    localStorage.setItem('sampleShopCart', JSON.stringify($rootScope.cart));
                }
            })
            .controller('searchController', function($scope, $rootScope, $location){
                $scope.partNumber = /\?partNumber=([^&#]*)/.exec($location.absUrl())[1];
                var db = {
                    '1111111' : [
                        {name: 'Bolt', price: 1.22, deliveryDays: 1},
                        {name: 'Bolt', price: 0.99, deliveryDays: 4}
                    ],
                    '2222222' : [
                        {name: 'Nut', price: 2.59, deliveryDays: 7},
                        {name: 'Nut', price: 2.00, deliveryDays: 1}
                    ],
                    '4444444' : [
                        {name: 'Relay', price: 15.99, deliveryDays: 1}
                    ]
                };
                $scope.searchResults = db[$scope.partNumber];
                if (!angular.isUndefined($scope.searchResults)) {
                    angular.forEach($scope.searchResults, function(result){
                        result.partNumber = $scope.partNumber;
                    });
                }
                $scope.addToCart = function(index){
                    var item = $scope.searchResults[index];
                    var quantity = parseInt(item.quantity);
                    if (quantity > 0){
                        item.wasAdded = quantity;
                        $rootScope.cart.items.push({partNumber: $scope.partNumber, name: item.name, price: item.price, amount: quantity});
                        $rootScope.cart.totalItems += quantity;
                        $rootScope.cart.totalCost += ($scope.searchResults[index].price * $scope.searchResults[index].wasAdded);
                        localStorage.setItem('sampleShopCart', JSON.stringify($rootScope.cart));
                    }
                }
            })
            ;
            angular.bootstrap(document, ["sampleShopApp"]);
        </script>
    </body>
</html>